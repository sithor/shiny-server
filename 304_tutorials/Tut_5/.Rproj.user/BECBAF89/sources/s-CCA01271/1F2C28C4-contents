## yak shaving

# ,__ ., __, ,,,,
# '--/,,\--'\*\%\*\
# //  \\\'\'%.\'%\
#       '..'//'%\.\%/\\'.^
#          \\'/'/%''/\'
#            ||     ||
#            "      "

if(!require(pacman)) install.packages("pacman")

pacman::p_load(rio, ## package for importing data easily
               magrittr, ## allows "piping" ("%>%") of commands to avoid brackets 
               visdat, skimr, # data exploration 
               car, #fancy plots
               httr,
               ggplot2, #fancy plots
               dplyr, 
               rmdHelpers,
               kableExtra,
               finalfit,
               epiDisplay,
               remotes, gradethis) # This is for making regression tables.
##############################################################################
if(!require(learnr)){
  remotes::install_github("rstudio/learnr")
} 

if(!require(gradethis)){
  remotes::install_github("rstudio/gradethis")
} 
missing_strings <- c("", NA, " ", "  ")

url <- "https://flexiblelearning.auckland.ac.nz/data-analysis/menu/1/files/simple_sids_epiinfo2.xlsx"

df <- rio::import(url, na = missing_strings)

## remove duplicates

df <- df[!duplicated(df),]

df$Mother_smoke %>% tab1

df$Case_status %>% tab1

df$Bedshare %>% tab1


df %>% names
## correct some data entry errors!----

df$Mother_smoke <- ifelse(df$Mother_smoke == 0, "No", df$Mother_smoke)
df$Mother_smoke <- ifelse(df$Mother_smoke == "_Yes", "Yes", df$Mother_smoke)
df$Mother_smoke %>% str

## scatterplots

car::scatterplot(Birth_wt ~ Gestation, data = df)



car::scatterplot(Birth_wt ~ Gestation | Mother_smoke, data = df)

## Simple linear regression

model <- lm(Birth_wt ~ Gestation, 
            data = df)
summary(model)
options(width = 300)
## Multiple linear regression, adjusting for confounders

model <- lm(Birth_wt ~ Gestation + Mother_smoke,
            data = df)
summary(model)

## explanatory variables are exposures of interest and confounders.
explanatory <- c("Mother_age", "Mother_smoke", "Gestation", "Ethnic")
dependent <- "Birth_wt" 

## This little bit of code saves a world of pain 
## and runs
## all the crude and adjusted models 
## and summarises into
## a table. Wonderful!!
df %>%
  finalfit::finalfit(dependent, explanatory, 
                     metrics = FALSE) -> regression_table
regression_table

## Fancy format for cutting and pasting into Excel
regress_tab <- knitr::kable(regression_table, row.names=FALSE, 
                            align=c("l", "l", "r", "r", "r"))

## Puts output into viewer so that it can be cut and pasted into Excel, 
## then Word.
regress_tab %>% kableExtra::kable_styling()


## rerun with metrics = TRUE
df %>%
  finalfit::finalfit(dependent, explanatory, 
                     metrics = TRUE) -> regression_table


## Fancy format for cutting and pasting into Excel
regress_tab <- knitr::kable(regression_table, row.names=FALSE, 
                            align=c("l", "l", "r", "r", "r"))

## Puts output into viewer so that it can be cut and pasted into Excel, 
## then Word.
regress_tab %>% kableExtra::kable_styling()

df$Mother_smoke %>% str
## Change character variable variables to factors
## So that our marginal model plot function works properly.
df$Mother_smoke <- as.factor(df$Mother_smoke)
df$Ethnic <- as.factor(df$Ethnic)

model <- lm(Birth_wt ~ Gestation + Mother_smoke +
              Mother_age + Ethnic,
            data = df)
summary(model)
## Checking for model fit
car::marginalModelPlots(model)

data("BP")
BP %>% head
BP$age_years <- difftime(as.POSIXct(Sys.Date()), BP$birthdate,
                   units = "days") %>% as.numeric %>% divide_by(365.25)
BP$age_years %>% summary

car::scatterplot(sbp ~ age_years | saltadd, data = BP)

## explanatory variables are exposures of interest and confounders.
explanatory <- c("age_years", "saltadd")
dependent <- "sbp" 

## This little bit of code saves a world of pain and runs
## all the crude and adjusted models and summarises into
## a table. Wonderful!!
BP %>%
  finalfit::finalfit(dependent, explanatory, 
                     metrics = FALSE) -> regression_table


## Fancy format for cutting and pasting into Excel
regress_tab <- knitr::kable(regression_table, row.names=FALSE, 
                            align=c("l", "l", "r", "r", "r"))

## Puts output into viewer so that it can be cut and pasted into Excel, 
## then Word.
regress_tab %>% kableExtra::kable_styling()


## rerun with metrics = TRUE
BP %>%
  finalfit::finalfit(dependent, explanatory, 
                     metrics = TRUE) -> regression_table


## Fancy format for cutting and pasting into Excel
regress_tab <- knitr::kable(regression_table, row.names=FALSE, 
                            align=c("l", "l", "r", "r", "r"))

## Puts output into viewer so that it can be cut and pasted into Excel, 
## then Word.
regress_tab %>% kableExtra::kable_styling()

model <- lm(sbp ~ age_years + saltadd,
            data = BP)
summary(model)

car::marginalModelPlots(model)

data("BP"); head(BP)

BP$age_years <- difftime(as.POSIXct(Sys.Date()), BP$birthdate,
                         units = "days") %>% as.numeric %>% divide_by(365.25)


